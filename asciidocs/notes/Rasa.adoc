ifndef::imagesdir[:imagesdir: ./images]

= Rasa Notes

== Rasa Products

The Rasa stack has two main components:

* Rasa Core

A chatbot framework with machine learning-based dialog management.

RASA Core refers to the main component, which receives and responds
to the requests.

ifdef::backend-html5,backend-revealjs[image:rasa-core.png[width=80%]]

* Rasa NLU

An intent classification module providing intent classification and entity extraction.

It has two parts:

* Training

This module allows you to train models on your own data. Having your own data to train allows you to develop a NLU that is business specific.

* Server

This module serves as the training model to the chatbot. It can be hosted as an API service and runs at the back end.

The message is basically handled at two stages: one at the Core
module, which manages the conversation, and one at the NLU module,
which provides the essential language services.

ifdef::backend-html5,backend-revealjs[image:rasa-core-nlu.png[width=80%]]

**Singh, Abhishek, Ramasubramanian, Karthik, Shivam, Shrey**: Building an Enterprise Chatbot
Work with Protected Enterprise Data Using Open Source Frameworks **ISBN**: https://isbnsearch.org/isbn/9781484250341[978-1-4842-5034-1]

=== Rasa Open Source

=== Rasa Enterprise

=== Rasa X


== Installation

1. Create your directory
2. Install Python 
[source,]
----
sudo apt update
sudo apt install python3-dev python3-pip python3-venv
----
3. Create a virtual environment (optional but recommended)
[source,]
----
python3 -m venv ./venv
source ./venv/bin/activate
----
4. Install Rasa Open Source
[source,]
----
pip3 install -U pip
pip3 install rasa
----

=== Conda

Conda ist ein Open-Source-Paketmanager der sowohl auf Windows, macOS und Linux läuft. Außerdem ist Conda auch ein environment manager mit dem man leicht environments erzeugen und wechseln kann, wenn man beispielsweise für eine bestimmte Anwendung eine andere Version eines Packages braucht.

In diesem Fall wurde Conda verwendet, da es beim Trainieren von Rasa Probleme und folgende Fehlermeldung beim Starten gab und ein möglicher Lösungsansatz dafür ist, dass man statt `pip` Conda verwendet.

[source,]
----
...
AttributeError: module ‘tensorflow.python.keras.engine.training’ has no attribute ‘enable_multi_worker’
----

https://forum.rasa.com/t/module-tensorflow-python-keras-engine-training-has-no-attribute-enable-multi-worker/41502

==== Installation

Falls man nach der Installation von Conda immer noch folgende Fehlermeldung bekommt, muss man noch Conda zum Path hinzufügen.

[source,]
----
conda: command not found
----

Dies macht man folgendermaßen:

[source,]
----
export PATH="/home/username/anaconda3/bin/:$PATH"
----

https://stackoverflow.com/questions/35246386/conda-command-not-found

==== Environment erstellen

Um ein Environment zu erstellen, müssen folgende Befehle ausgeführt werden:

[source,]
----
conda create --name rasa_env python=3.7
conda activate rasa_env
----

https://conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html

Anschließend müssen Rasa und alle gewünschten Packages installiert werden

== Create the project

- To initalize to project you need to run

[source,]
----
rasa init
----

ifdef::backend-html5,backend-revealjs[image:rasa_init.png[]]

You can also use Docker for this. The only difference with this is that you'll be running Rasa inside a Docker container.

[source,]
----
docker run -v $(pwd):/app rasa/rasa:2.8.0-full init --no-prompt
----

- After that you can open the project in your preferred IDE.

- To start a server with your trained model you use

[source,]
----
rasa run
----

== Train your bot

=== Add new intents

Intents are stored in the `data/nlu.md` file.
The syntax to create a new intent is as following:

[source,]
----
## intent:<intent name>
- <phrase 1>
- <phrase 2>
- <phrase 3>
----

If you're using a newer version of Rasa you'll have a `nlu.yml` file insead

[source,]
----
- intent: <intent name>
  examples: |
    - <phrase 1>
    - <phrase 2>
    - <phrase 3>
----

Now to identify these new intents you have to add them to the list found
in your `domain.yml` file.

[source,]
----
intents:
  - greet
  - goodbye
  - affirm
  - deny
  - mood_great
  - mood_unhappy
  - bot_challenge
  - <your newly created intent>
  ...
----

=== Add responses

To add responses the chatbot should give go to the `domain.yml` file. 
The syntax for adding a new response looks like this:

[source,]
----
responses:
  utter_greet:
  - text: "Hey! How are you?"
  
  utter_<name of your response>:
  - text: "<text>"
    image: "<img link>"
  ...
----

=== Create stories

To use your created intents and responses you have to define so-called 
`stories` in your `data/stories.yml` file.

The syntax for markdown looks like this:

[source,]
----
## <name of your story>
* <name of the intent that is triggered>
  - <response that should be provided>
----

And this is the syntax for yml files:

[source,]
----
- story: <name of your story>
  steps:
    - intent: <name of the intent that is triggered>
    - action: <response that should be provided>
    - intent: <name of the intent that is triggered>
    - action: <response that should be provided>
    ...
----

=== Run your new stories

At first you have to re-train your model. This allows the model 
to learn all the things we just implemented to the training data and
the domain file.

To train your model you need to run:

[source,]
----
rasa train
----

After that you can start the server and initiate a chat-session
through the `rasa shell` command.


[source,]
----
rasa shell
----

Now you can start asking your bot your new defined questions. Keep in mind that the text doesn't have to be exactly like you wrote it and that the assistant will still be able to recognize it even with a few differences.

ifdef::backend-html5,backend-revealjs[image:rasa_shell.png[]]

== Slots

Slots are the bot's memory. They are key-value pairs and can be used to store information the user provided, similiar to entities, like locations or information about the outside world.

In this example we are using slots for a form. 

The syntax for creating a slot inside the `domain.yml` file is as follows:

[source,]
----
slots:
  slot_name: <slot name>
    type: <type>
----

== Entities

Entities are structured pieces of information inside a user message like for example a location or a job or a name.

In your `domain.yml` file you write:

[source,]
----
entities:
  - <entity name>
  - <entity name>
----

To specify the entity in your intents you write:

== NLU Pipeline

Rasa Open Source provides a default NLU config on initialization of the project.

In Rasa Open Source, incoming messages are processed by a sequence of components. These components are executed one after another in a so-called processing pipeline defined in your config.yml. Choosing an NLU pipeline allows you to customize your model and finetune it on your dataset.

Here you can see how the components and their lifecycle works:

ifdef::backend-html5,backend-revealjs[image:component-lifecycle.png[]]

https://rasa.com/docs/rasa/tuning-your-model

You can view every component here:

https://rasa.com/docs/rasa/components

https://rasahq.github.io/rasa-nlu-examples/

=== Comparing NLU Pipelines

You can compare two NLU pipelines by using this command

[source,]
----
rasa test nlu --nlu data/nlu.yml --config config_1.yml config_2.yml
----

== Rasa Action Server

A Rasa action server runs custom actions for a Rasa Open Source conversational assistant.

When your assistant predicts a custom action, the Rasa server sends a POST request to the action server with a json payload including the name of the predicted action, the conversation ID, the contents of the tracker and the contents of the domain.

=== Running the Rasa SDK Action Server

There are two ways to run the action server, depending on whether or not you are using an environment with `rasa` installed or not.

If you have `rasa` installed you can use:

[source,]
----
rasa run actions
----

Or else use:

[source,]
----
python -m rasa_sdk --actions actions
----

We are now running two servers, one for `Rasa Open Source` and the `Rasa Action Server`.

== Airtable

For the tutorial `Rasa for Beginners` on Udemy we used a template for an Airtable workspace.

You need to define three keys when working with Airtable. 

The `API_KEY` which is obtained on your `/account` page.

ifdef::backend-html5,backend-revealjs[image:api_key.png[width=80%]]

Your `BASE_ID` which you when you're in your `API Docs`. And the 
`TABLE_NAME` which you'll also get there.

image::images/base_id.png[]

Now export your keys in a `.env.sh` and `.env` file.

Note that the `TABLE_NAME` uses HTML to encode the name and `%20` is for the space character.

[source,]
----
export AIRTABLE_API_KEY=key***
export BASE_ID=app***
export TABLE_NAME=Table%201
----

To keep our credentials seperate from other code we'll use `python-dotenv`. You install it through:

[source,]
----
pip install python-dotenv
----

Now to run the action server you use:

[source,]
----
rasa run actions
----

And in another terminal you start `Rasa Open Source` through:

[source,]
----
rasa shell
----

Now after you've taken part in the survey a new line in your Airtable will be inserted

ifdef::backend-html5,backend-revealjs[image:airtable-new.png[]]

== Twilio

=== Ngrok

To connect to Twilio we'll have to use this tool, which simulates hosting a system to a server. It creates a tunnel URL.

To install Ngrok use:

[source,]
----
sudo snap install ngrok
----

After that connect Ngrok to your account through

[source,]
----
ngrok auththoken <your token>
----

Then you can use Ngrok to create a tunnel for you. In this case
we want it for the `http port 5005`.

Note that this URL is only temporary and you always have to restart it when you want to use it.

[source,]
----
ngrok http 5005
----

In the `Rasa for beginners` course we connect to Twilio, which provides developer-friendly APIs for text messages.

At first you have to register for an account.

In your `credentials.yml` file you can now save the data of Twilio.

[source,]
----
twilio:
  account_sid: "<your SID>"
  auth_token: "<your token>"
  twilio_number: "<your twilio number>"
----

Now you need to restart Rasa through 

[source,]
----
rasa run
----

Also Ngrok should be running and you have to insert your URL
into Twilio.

ifdef::backend-html5,backend-revealjs[image:twilio-ngrok.png[]]

Now you can chat with your assistant via SMS.

ifdef::backend-html5,backend-revealjs[image:chat-twilio.jpeg[width=30%]]

ifdef::backend-html5,backend-revealjs[image:chat-info.jpeg[width=30%]]

== Conversation-Driven Development CDD

Conversation-Driven Development is the process of listening to your users and using those insights to improve your AI assistant. 

The way we wrote phrases that the user might come up with doesn't 
connect to the real world. People are different in the way that
they phrase something based on their age, background and other factors.

Also there's the "curse of knowledge" which means that we know our
application well and we know how to phrase something in order
to get the correct answer but other people don't have that. 
So in other words we can't imagine how an user who doesn't know
something might use the bot.

It is really important that you test your application with real
world people even though it might feel uncomfortable at first.

There are 6 factors of CDD:

1. Share
2. Review
3. Annotate
4. Test
5. Track
6. Fix


== Rasa X

- Layers on top of Rasa Open Source and helps you build a better assistant
- Can be deployed anywhere, so your training data stays secure and proprietary
- Runs in the browser
- Let's you talk to your bot
- Helps to correct model predictions
- Share your application with test users
- Review conversations
- Annotate user messages


In the process of `Deployment` you expose your application to a
server rather than still using it locally. 


=== Installation

Es gibt verschieden Arten, um Rasa X zu installieren.

==== Local Mode

Um Rasa X lokal zu installieren, verwendet man folgenden Befehl:

[source,]
----
pip3 install rasa-x --extra-index-url https://pypi.rasa.com/simple
----

==== Troubleshooting

Dies kann allerdings zu Problemen führen, bei denen die Installation stockt und nie beendet wird. Dies liegt daran, dass in pip 20.3 obenstehendes nicht funktioniert. Man kann also entweder eine ältere Version verwenden oder einstellen, dass noch die alte Logik verwenden sollte.

[source,]
----
INFO: pip is looking at multiple versions of sniffio to determine which version is compatible with other requirements. This could take a while.
----

https://forum.rasa.com/t/rasa-x-install-stucked/39640

https://stackoverflow.com/questions/65806524/pip-install-rasa-x-takes-forever/65812957#65812957

Außerdem kann es immer noch zu Problemen mit den Versionen der verschiedenen Packages und Rasa X kommen. In folgenden Links werden Beispiele dafür und die Lösungen für diese Probleme geschildert.

https://forum.rasa.com/t/rasa-x-dont-work/46931/9

https://forum.rasa.com/t/rasa-x-0-23-0-error-in-endpoints-yml/21744/4

Um Rasa X nun zu starten, verwendet man folgenden Befehl:

[source,]
----
rasa x
----

Dieser öffnet einen Browser Tab unter der Adresse `http://localhost:5002`.

== Troubleshooting

=== Port 5005 already in use

If you're having trouble with `rasa init` because the port `5005` is already in use try to find the process, that is listening on this port, and kill it for example like this:

[source,]
----
lsof -i -P -n | grep LISTEN
kill <id of process>
----

ifdef::backend-html5,backend-revealjs[image:kill_process.png[]]

=== Rasa: command not found

This could be because pip, pip3 and pip3.8 are all installed in `/home/user/.local/bin` which is not in the PATH. In order to fix this you have to export this path to to the path variable.

[source,]
----
export PATH="$HOME/.local/bin:$PATH"
----

== Links

Links used for this documentation are:

https://www.udemy.com/course/rasa-for-beginners/

https://blog.rasa.com/conversation-driven-development-a-better-approach-to-building-ai-assistants/

https://rasa.com/docs/rasa/

https://rasa.com/docs/rasa/docker/building-in-docker/

https://rasa.com/docs/rasa/tuning-your-model

https://rasa.com/docs/rasa/components

https://rasahq.github.io/rasa-nlu-examples/

Singh, Abhishek, Ramasubramanian, Karthik, Shivam, Shrey: Building an Enterprise Chatbot
Work with Protected Enterprise Data Using Open Source Frameworks **ISBN**: [978-1-4842-5034-1]

https://forum.rasa.com/t/module-tensorflow-python-keras-engine-training-has-no-attribute-enable-multi-worker/41502